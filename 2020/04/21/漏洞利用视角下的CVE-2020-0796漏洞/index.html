<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.stxletto.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="漏洞利用视角下的CVE-2020-0796漏洞1 概述初见是惊鸿一瞥，重逢是始料未及。 各位“蓝颜知己”我们又见面了，本文是《漏洞分析视角下的CVE-2020-0796漏洞》的兄弟篇。CVE-2020-796漏洞成因已经在前文说明，这次我们从漏洞利用视角来看看CVE-2020-796漏洞。 这次我们分析对象是github.com&#x2F;danigargu上的本地权限提升(LPE，Local Privil">
<meta property="og:type" content="article">
<meta property="og:title" content="漏洞利用视角下的CVE-2020-0796漏洞">
<meta property="og:url" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="深澜深蓝">
<meta property="og:description" content="漏洞利用视角下的CVE-2020-0796漏洞1 概述初见是惊鸿一瞥，重逢是始料未及。 各位“蓝颜知己”我们又见面了，本文是《漏洞分析视角下的CVE-2020-0796漏洞》的兄弟篇。CVE-2020-796漏洞成因已经在前文说明，这次我们从漏洞利用视角来看看CVE-2020-796漏洞。 这次我们分析对象是github.com&#x2F;danigargu上的本地权限提升(LPE，Local Privil">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-1.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-2.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-3.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-4.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-5.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-6.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-7.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-8.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-9.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-10.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-11.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-12.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-13.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-14.jpg">
<meta property="og:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-15.jpg">
<meta property="article:published_time" content="2020-04-21T00:00:00.000Z">
<meta property="article:modified_time" content="2020-05-05T15:25:41.774Z">
<meta property="article:author" content="stxletto">
<meta property="article:tag" content="安全">
<meta property="article:tag" content="漏洞">
<meta property="article:tag" content="分析">
<meta property="article:tag" content="威胁">
<meta property="article:tag" content="识别">
<meta property="article:tag" content="检测">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-1.jpg">

<link rel="canonical" href="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>漏洞利用视角下的CVE-2020-0796漏洞 | 深澜深蓝</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">深澜深蓝</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>作品</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.stxletto.com/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="stxletto">
      <meta itemprop="description" content="安全风云波澜壮阔，对酒当歌人间值得。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="深澜深蓝">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          漏洞利用视角下的CVE-2020-0796漏洞
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-21 08:00:00" itemprop="dateCreated datePublished" datetime="2020-04-21T08:00:00+08:00">2020-04-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-05 23:25:41" itemprop="dateModified" datetime="2020-05-05T23:25:41+08:00">2020-05-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="漏洞利用视角下的CVE-2020-0796漏洞"><a href="#漏洞利用视角下的CVE-2020-0796漏洞" class="headerlink" title="漏洞利用视角下的CVE-2020-0796漏洞"></a>漏洞利用视角下的CVE-2020-0796漏洞</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1 概述"></a>1 概述</h2><p>初见是惊鸿一瞥，重逢是始料未及。</p>
<p>各位“蓝颜知己”我们又见面了，本文是《漏洞分析视角下的CVE-2020-0796漏洞》的兄弟篇。CVE-2020-796漏洞成因已经在前文说明，这次我们从漏洞利用视角来看看CVE-2020-796漏洞。</p>
<p>这次我们分析对象是github.com/danigargu上的本地权限提升(LPE，Local Privilege Escalation)利用(Exploit)。</p>
<p>LPE的exploit是以C++源码形式提供的，这也有便于我们分析exploit开发原理。我们可以用Microsoft Visual Studio编译它。然后以非管理员身份运行cmd程序，执行编译后的文件cve-2020-07960local.exe。如图1所示：</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-1.jpg" alt="img"></p>
<center>图1</center>

<p>在exploit执行前后的whoami命令显示用户名并未改变。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-2.jpg" alt="img"></p>
<center>图2</center>

<p>如图2所示，而是新弹出一个cmd的界面，在其中执行whoami显示用户名已经被修改为nt authority\system</p>
<p>幸亏本文标题不是《漏洞复现视角下的CVE-2020-0796漏洞》，不然本文就到此为止了。由此可见选一个好标题的重要性，来让我们看看，这一闪而显的黑窗口背后发生了什么。</p>
<h2 id="2-一串神奇的数字"><a href="#2-一串神奇的数字" class="headerlink" title="2 一串神奇的数字"></a>2 一串神奇的数字</h2><p>使用之前分析工作中的断点，查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp srv2!Srv2DecompressData+0x108 &quot;.printf \&quot;srv2!memmove(Src&#x3D;0x%I64x, Dst&#x3D;0x%I64x,Size&#x3D;%d) \n\&quot;, rdx, rcx, r8d;db rdx;.echo&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">srv2!memmove(Src&#x3D;0xffffc68fe8ee2840, Dst&#x3D;0xffff8d8dec51e0a0,Size&#x3D;16)</span><br><span class="line"></span><br><span class="line">kd&gt; r</span><br><span class="line">rax&#x3D;ffffc68fe8ee2540 rbx&#x3D;ffffc68fea74c150 rcx&#x3D;ffff8d8dec51e0a0</span><br><span class="line">rdx&#x3D;ffffc68fe8ee2840 rsi&#x3D;0000000000000010 rdi&#x3D;ffffc68fe8ee22c0</span><br><span class="line">rip&#x3D;fffff80fae8a7f68 rsp&#x3D;fffff2013002ee70 rbp&#x3D;0000000000000002</span><br><span class="line"> r8&#x3D;0000000000000010 r9&#x3D;ffffc68fea9012a0 r10&#x3D;ffffc68fe7e02160</span><br><span class="line">r11&#x3D;fffff2013002ee50 r12&#x3D;0000000000000000 r13&#x3D;ffffc68fec5ff240</span><br><span class="line">r14&#x3D;00000000ffffffff r15&#x3D;0000000000000000</span><br><span class="line">iopl&#x3D;0     nv up ei ng nz na pe nc</span><br><span class="line">cs&#x3D;0010 ss&#x3D;0018 ds&#x3D;002b es&#x3D;002b fs&#x3D;0053 gs&#x3D;002b       efl&#x3D;00000282</span><br><span class="line">srv2!Srv2DecompressData+0x108:</span><br><span class="line">fffff80f&#96;ae8a7f68 e85376ffff   call  srv2!memcpy (fffff80f&#96;ae89f5c0)</span><br></pre></td></tr></table></figure>

<p>目的地址内存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; db 0xffff8d8dec51e0a0 L0n16</span><br><span class="line">ffff8d8d&#96;ec51e0a0 00 00 88 02 06 00 00 00-00 00 80 00 00 00 00 00 ................</span><br></pre></td></tr></table></figure>

<p>源地址内存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; db 0xffffc68fe8ee2840 L0n16</span><br><span class="line">ffffc68f&#96;e8ee2840 bc ff ff f2 1f 00 00 00-bc ff ff f2 1f 00 00 00 ................</span><br></pre></td></tr></table></figure>

<p>这个Exploit要从一个特定的地址读16字节的数据，然后再写入另一个特定的地方去。</p>
<p>根据前文的分析，此处memmove的函数，是要把数据流头部未压缩的数据，移动过来，完成预定的解压缩业务流程。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-3.jpg" alt="img"></p>
<center>图3</center>

<p>如图3所示，从我们抓到的流量数据来看，offset大小与memmove的size，以及数据和数据的确能匹配上。</p>
<p>我们要搞明白这个来自网络流中，现在是memmove的源地址存放的数据，对这个特定目的地址来说有什么特别的意义。</p>
<p>一番眼花缭乱的操作之后，“我不再是我”。我们需要额外了解一些关于Windows内核提权的小技巧。</p>
<p>这是一个在虚拟世界中如何向Windows“证明你自己是你自己”的问题。和现实世界中“大内侍卫凌凌漆的腰牌”有些类似。</p>
<h2 id="3-进程的访问令牌"><a href="#3-进程的访问令牌" class="headerlink" title="3 进程的访问令牌"></a>3 进程的访问令牌</h2><p>微软文档中关于访问令牌（Access Token，原文详见引用2）的描述如下：</p>
<p>访问令牌是一个描述进程或线程的安全上下文的对象。令牌中的信息包括与进程或线程关联的用户帐号的标识和特权。当用户登录时，系统通过将用户密码与安全数据库中存储的信息进行比较来验证用户密码。如果密码通过了验证，则系统将生成一个访问令牌。 以该用户名义执行的每个进程都有此访问令牌的副本。</p>
<p>当线程与安全对象进行交互或尝试执行需要特权的系统任务时，系统使用访问令牌来标识用户。 访问令牌包含以下信息：</p>
<p>·     用户帐号的<a href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/security-identifiers" target="_blank" rel="noopener">安全标识符</a>（SID）<br>·     用户所属的组的SID<br>·     标识当前登录会话的登录SID<br>·     用户或用户组拥有的<a href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/privileges" target="_blank" rel="noopener">特权</a>列表<br>·     所有者SID<br>·     主要组（primary group）的SID<br>·     用户创建安全对象而没有指定<a href="https://docs.microsoft.com/windows/desktop/SecGloss/s-gly" target="_blank" rel="noopener"><em>安全描述符</em></a>时，系统使用的默认<a href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/access-control-lists" target="_blank" rel="noopener">DACL</a><br>·     访问令牌的来源<br>·     令牌是<a href="https://docs.microsoft.com/windows/desktop/SecGloss/p-gly" target="_blank" rel="noopener">主</a>令牌(<a href="https://docs.microsoft.com/windows/desktop/SecGloss/p-gly" target="_blank" rel="noopener"><em>primary</em></a> token）还是<a href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/client-impersonation" target="_blank" rel="noopener">模拟</a>令牌（<a href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/client-impersonation" target="_blank" rel="noopener">impersonation</a> token）<br>·     <a href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/restricted-tokens" target="_blank" rel="noopener">限制SID</a>（<a href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/restricted-tokens" target="_blank" rel="noopener">restricting SIDs</a>）的可选列表<br>·     当前的模拟级别<br>·     其他统计信息</p>
<p>每个进程都有一个主要令牌，用于描述与该进程关联的用户帐号的安全上下文。 默认情况下，当进程的线程与安全对象进行交互时，系统将使用主令牌。 此外，线程可以模拟当事人帐号（client account）。 模拟允许线程使用当事人的安全上下文与安全对象进行交互。 模拟当事人的线程同时具有主令牌和模拟令牌。</p>
<h2 id="4-ATT-amp-CK中的访问令牌操纵攻击技术"><a href="#4-ATT-amp-CK中的访问令牌操纵攻击技术" class="headerlink" title="4 ATT&amp;CK中的访问令牌操纵攻击技术"></a>4 ATT&amp;CK中的访问令牌操纵攻击技术</h2><p>MITRE ATT&amp;CK®是一个基于真实世界的观察对手的战术和技术的可全球访问的知识库。ATT＆CK知识库被用作在私营部门、政府以及网络安全产品和服务社区中开发特定威胁模型和方法的基础。</p>
<p>在权限提升（<a href="https://attack.mitre.org/tactics/TA0004/" target="_blank" rel="noopener">Privilege Escalation</a>）一节中的访问令牌操纵（<a href="https://attack.mitre.org/techniques/T1134" target="_blank" rel="noopener">Access Token Manipulation</a>）详细介绍了在Windows系统中通过如何操纵访问令牌来提升权限的技巧。</p>
<p>Windows使用访问令牌来确定正在运行的进程的所有权。用户可以操纵访问令牌以使正在运行的进程看起来像它属于启动该进程的用户以外的其他人。发生这种情况时，该进程还将采用与新令牌关联的安全上下文。例如，Microsoft提倡使用访问令牌作为最佳安全实践。管理员应以标准用户身份登录，通过内置的访问令牌操作命令runas，以管理员特权运行其工具。</p>
<p>攻击者可以使用访问令牌在不同的用户或系统安全上下文下进行操作，并逃避检测。对手可以使用内置的Windows API函数来复制现有进程中的访问令牌；这被称为令牌窃取。对手必须已经在特权用户上下文（即管理员）中才能窃取令牌。但是，攻击者通常使用令牌窃取来将其安全上下文从管理员级别提升到SYSTEM级别。如果帐户在远程系统上具有适当的权限，则对手可以使用令牌作为该令牌的帐户向远程系统进行身份验证。</p>
<h2 id="5-手动修改访问令牌"><a href="#5-手动修改访问令牌" class="headerlink" title="5 手动修改访问令牌"></a>5 手动修改访问令牌</h2><p>我们了解到Windows识别进程的身份靠的就是这个令牌。在Windows中应用态的内存可被进程任意读写，为了更好地安全性，Windows把令牌（token）的放进了内核态。</p>
<p>先看其中一个手动修改方法：</p>
<p>WinDBG中的!process扩展命令会显示指定进程或者全部进程的EPROCESS块信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process 0 0 System</span><br><span class="line">PROCESS ffff980dd646a380</span><br><span class="line">  SessionId: none Cid: 0004  Peb: 00000000 ParentCid: 0000</span><br><span class="line">  DirBase: 001ad002 ObjectTable: ffffd5872c604b80 HandleCount: 2203.</span><br><span class="line">  Image: System</span><br></pre></td></tr></table></figure>

<p>其中的PROCESS ffff980dd646a380即表示System进程的EPROCESS的内存地址是0x ffff980dd646a380。</p>
<p>可使用dt _EPROCESS指令查看0x ffff980dd646a380地址处的EPROCESS块信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _EPROCESS ffff980dd646a380</span><br><span class="line">nt!_EPROCESS</span><br><span class="line">  +0x000 Pcb       : _KPROCESS</span><br><span class="line">  +0x2e0 ProcessLock   : _EX_PUSH_LOCK</span><br><span class="line">  +0x2e8 UniqueProcessId : 0x00000000&#96;00000004 Void</span><br><span class="line">  +0x2f0 ActiveProcessLinks : _LIST_ENTRY [ 0xffff980d&#96;d64d2370 - 0xfffff804&#96;6ece1bc0 ]</span><br><span class="line">  +0x300 RundownProtect  : _EX_RUNDOWN_REF</span><br><span class="line">..</span><br><span class="line">  +0x360 Token      : _EX_FAST_REF</span><br><span class="line">..</span><br></pre></td></tr></table></figure>

<p>EPROCESS是较大的结构体，我们省略了部分，重点关注0x360偏移处的这个Token结构。该结构是一个_EX_FAST_REF类型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _EX_FAST_REF</span><br><span class="line">nt!_EX_FAST_REF</span><br><span class="line">  +0x000 Object      : Ptr64 Void</span><br><span class="line">  +0x000 RefCnt      : Pos 0, 4 Bits</span><br><span class="line">  +0x000 Value      : Uint8B</span><br></pre></td></tr></table></figure>

<p>观察_EX_FAST_REF字段定义可知，0~4bit是引用计数，其余bit位才是value。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq ffff980dd646a380+0x360 L1</span><br><span class="line">ffff980d&#96;d646a6e0 ffffd587&#96;2c60604f</span><br></pre></td></tr></table></figure>

<p>一般会通过位与法获得最终的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; ? ffffd587&#96;2c60604f &amp; ffffffff&#96;fffffff0</span><br><span class="line">Evaluate expression: -46698434895808 &#x3D; ffffd587&#96;2c606040</span><br></pre></td></tr></table></figure>

<p>可使用!token扩展指令查看令牌的具体结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !token ffffd587&#96;2c606040</span><br><span class="line">_TOKEN 0xffffd5872c606040</span><br><span class="line">TS Session ID: 0</span><br><span class="line">User: S-1-5-18</span><br><span class="line">User Groups: </span><br><span class="line"> 00 S-1-5-32-544  Attributes - Default Enabled Owner </span><br><span class="line"> 01 S-1-1-0  Attributes - Mandatory Default Enabled </span><br><span class="line"> 02 S-1-5-11  Attributes - Mandatory Default Enabled </span><br><span class="line"> 03 S-1-16-16384  Attributes - GroupIntegrity GroupIntegrityEnabled </span><br><span class="line"></span><br><span class="line">Primary Group: S-1-5-18</span><br><span class="line"></span><br><span class="line">Privs: </span><br><span class="line"> 02 0x000000002 SeCreateTokenPrivilege      Attributes - </span><br><span class="line"> 03 0x000000003 SeAssignPrimaryTokenPrivilege   Attributes - </span><br><span class="line"> 04 0x000000004 SeLockMemoryPrivilege       Attributes - Enabled Default </span><br><span class="line"> 05 0x000000005 SeIncreaseQuotaPrivilege     Attributes - </span><br><span class="line"> 07 0x000000007 SeTcbPrivilege          Attributes - Enabled Default </span><br><span class="line"> 08 0x000000008 SeSecurityPrivilege        Attributes - </span><br><span class="line"> 09 0x000000009 SeTakeOwnershipPrivilege     Attributes - </span><br><span class="line"> 10 0x00000000a SeLoadDriverPrivilege       Attributes - </span><br><span class="line"> 11 0x00000000b SeSystemProfilePrivilege     Attributes - Enabled Default </span><br><span class="line"> 12 0x00000000c SeSystemtimePrivilege       Attributes - </span><br><span class="line"> 13 0x00000000d SeProfileSingleProcessPrivilege  Attributes - Enabled Default </span><br><span class="line"> 14 0x00000000e SeIncreaseBasePriorityPrivilege  Attributes - Enabled Default </span><br><span class="line"> 15 0x00000000f SeCreatePagefilePrivilege     Attributes - Enabled Default </span><br><span class="line"> 16 0x000000010 SeCreatePermanentPrivilege    Attributes - Enabled Default </span><br><span class="line"> 17 0x000000011 SeBackupPrivilege         Attributes - </span><br><span class="line"> 18 0x000000012 SeRestorePrivilege        Attributes - </span><br><span class="line"> 19 0x000000013 SeShutdownPrivilege        Attributes - </span><br><span class="line"> 20 0x000000014 SeDebugPrivilege         Attributes - Enabled Default </span><br><span class="line"> 21 0x000000015 SeAuditPrivilege         Attributes - Enabled Default </span><br><span class="line"> 22 0x000000016 SeSystemEnvironmentPrivilege   Attributes - </span><br><span class="line"> 23 0x000000017 SeChangeNotifyPrivilege      Attributes - Enabled Default </span><br><span class="line"> 25 0x000000019 SeUndockPrivilege         Attributes - </span><br><span class="line"> 28 0x00000001c SeManageVolumePrivilege      Attributes - </span><br><span class="line"> 29 0x00000001d SeImpersonatePrivilege      Attributes - Enabled Default </span><br><span class="line"> 30 0x00000001e SeCreateGlobalPrivilege      Attributes - Enabled Default </span><br><span class="line"> 31 0x00000001f SeTrustedCredManAccessPrivilege  Attributes - </span><br><span class="line"> 32 0x000000020 SeRelabelPrivilege        Attributes - </span><br><span class="line"> 33 0x000000021 SeIncreaseWorkingSetPrivilege   Attributes - Enabled Default </span><br><span class="line"> 34 0x000000022 SeTimeZonePrivilege        Attributes - Enabled Default </span><br><span class="line"> 35 0x000000023 SeCreateSymbolicLinkPrivilege   Attributes - Enabled Default </span><br><span class="line"> 36 0x000000024 SeDelegateSessionUserImpersonatePrivilege Attributes - Enabled Default </span><br><span class="line"></span><br><span class="line">Authentication ID:     (0,3e7)</span><br><span class="line">Impersonation Level:    Anonymous</span><br><span class="line">TokenType:         Primary</span><br><span class="line">Source: *SYSTEM*      TokenFlags: 0x2000 ( Token in use )</span><br><span class="line">Token ID: 3eb       ParentToken ID: 0</span><br><span class="line">Modified ID:        (0, 3ec)</span><br><span class="line">RestrictedSidCount: 0   RestrictedSids: 0x0000000000000000</span><br><span class="line">OriginatingLogonSession: 0</span><br><span class="line">PackageSid: (null)</span><br><span class="line">CapabilityCount: 0   Capabilities: 0x0000000000000000</span><br><span class="line">LowboxNumberEntry: 0x0000000000000000</span><br><span class="line">Security Attributes:</span><br><span class="line">Invalid AUTHZBASEP_SECURITY_ATTRIBUTES_INFORMATION with no claims</span><br><span class="line">Process Token TrustLevelSid: S-1-19-1024-8192</span><br></pre></td></tr></table></figure>

<p>也可使用dt _TOKEN查看字段定义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _TOKEN</span><br><span class="line">nt!_TOKEN</span><br><span class="line">  +0x000 TokenSource   : _TOKEN_SOURCE</span><br><span class="line">  +0x010 TokenId     : _LUID</span><br><span class="line">  +0x018 AuthenticationId : _LUID</span><br><span class="line">  +0x020 ParentTokenId  : _LUID</span><br><span class="line">  +0x028 ExpirationTime  : _LARGE_INTEGER</span><br><span class="line">  +0x030 TokenLock    : Ptr64 _ERESOURCE</span><br><span class="line">  +0x038 ModifiedId    : _LUID</span><br><span class="line">  +0x040 Privileges    : _SEP_TOKEN_PRIVILEGES</span><br><span class="line">  +0x058 AuditPolicy   : _SEP_AUDIT_POLICY</span><br><span class="line">  ..</span><br></pre></td></tr></table></figure>

<p>在尝试把替换cmd.exe进程的TOKEN指针之前，我们先执行一下whoami看看。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-4.jpg" alt="img"></p>
<center>图4</center>

<p>如图4中，whoami显示，当前账户是admin。</p>
<p>手动查看cmd.exe进程的TOKEN指针和前文所述基本一致，不再赘述。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process 0 0 cmd.exe</span><br><span class="line">PROCESS ffff980ddcba8080</span><br><span class="line">  SessionId: 1 Cid: 0ae8  Peb: 1265dcd000 ParentCid: 0d38</span><br><span class="line">  DirBase: 530d6002 ObjectTable: ffffd58733943400 HandleCount: 75.</span><br><span class="line">  Image: cmd.exe</span><br></pre></td></tr></table></figure>

<p>然后把cmd.exe进程的TOKEN指针替换为system的TOKEN指针。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; eq ffff980ddcba8080+0x360 ffffd587&#96;2c606040</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-5.jpg" alt="img"></p>
<center>图5</center>

<p>如图5中，再执行一下whoami显示，当前账户已经由admin变化为nt authority\system。</p>
<h2 id="6-TOKEN-0x40偏移"><a href="#6-TOKEN-0x40偏移" class="headerlink" title="6 TOKEN+0x40偏移"></a>6 TOKEN+0x40偏移</h2><p>我们现在来看看memmove()函数的目的地址是否就是cve-2020-0796-local.exe进程的TOKEN指针。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">srv2!memmove(Src&#x3D;0xffff8205e4678590, Dst&#x3D;0xffff998e13d780a0,Size&#x3D;16)</span><br><span class="line"></span><br><span class="line">kd&gt; r</span><br><span class="line">rax&#x3D;ffff8205e4678290 rbx&#x3D;ffff8205e9ad4150 rcx&#x3D;ffff998e13d780a0</span><br><span class="line">rdx&#x3D;ffff8205e4678590 rsi&#x3D;0000000000000010 rdi&#x3D;ffff8205e4678010</span><br><span class="line">rip&#x3D;fffff80218327f68 rsp&#x3D;ffffe8861b123e70 rbp&#x3D;0000000000000002</span><br><span class="line"> r8&#x3D;0000000000000010 r9&#x3D;0000000000000000 r10&#x3D;ffff8205df002290</span><br><span class="line">r11&#x3D;ffffe8861b123e50 r12&#x3D;0000000000000000 r13&#x3D;ffff8205e8434680</span><br><span class="line">r14&#x3D;00000000ffffffff r15&#x3D;0000000000000000</span><br><span class="line">iopl&#x3D;0     nv up ei ng nz na po nc</span><br><span class="line">cs&#x3D;0010 ss&#x3D;0018 ds&#x3D;002b es&#x3D;002b fs&#x3D;0053 gs&#x3D;002b       efl&#x3D;00000286</span><br><span class="line">srv2!Srv2DecompressData+0x108:</span><br><span class="line">fffff802&#96;18327f68 e85376ffff   call  srv2!memcpy (fffff802&#96;1831f5c0)</span><br><span class="line"></span><br><span class="line">kd&gt; db rdx L0n16</span><br><span class="line">ffff8205&#96;e4678590 bc ff ff f2 1f 00 00 00-bc ff ff f2 1f 00 00 00 ................</span><br><span class="line"></span><br><span class="line">kd&gt; db rcx L0n16</span><br><span class="line">ffff998e&#96;13d780a0 00 00 88 02 06 00 00 00-00 00 80 00 00 00 00 00 ................</span><br><span class="line"></span><br><span class="line">kd&gt; !process 0 0 cve-2020-0796-local.exe</span><br><span class="line">PROCESS ffff8205e9ad5080</span><br><span class="line">  SessionId: 1 Cid: 16e0  Peb: 44e943b000 ParentCid: 024c</span><br><span class="line">  DirBase: 1abc2002 ObjectTable: ffff998e13777580 HandleCount: 58.</span><br><span class="line">  Image: cve-2020-0796-local.exe</span><br><span class="line"></span><br><span class="line">kd&gt; dq ffff8205e9ad5080+0x360 L1</span><br><span class="line">ffff8205&#96;e9ad53e0 ffff998e&#96;13d7806e</span><br></pre></td></tr></table></figure>

<p>我们发现memmove()函数的目的地0xffff998e<code>13d780a0和cve-2020-0796-local.exe进程的TOKEN指针存放地址ffff8205</code>e9ad53e0相去甚远。但却指向ffff998e`13d78060+0x40处。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _TOKEN</span><br><span class="line">nt!_TOKEN</span><br><span class="line">  +0x000 TokenSource   : _TOKEN_SOURCE</span><br><span class="line">  +0x010 TokenId     : _LUID</span><br><span class="line">  +0x018 AuthenticationId : _LUID</span><br><span class="line">  +0x020 ParentTokenId  : _LUID</span><br><span class="line">  +0x028 ExpirationTime  : _LARGE_INTEGER</span><br><span class="line">  +0x030 TokenLock    : Ptr64 _ERESOURCE</span><br><span class="line">  +0x038 ModifiedId    : _LUID</span><br><span class="line">  +0x040 Privileges    : _SEP_TOKEN_PRIVILEGES</span><br></pre></td></tr></table></figure>

<p>从_TOKEN结构体的定义中，我们了解在0x40偏移处是一个_SEP_TOKEN_PRIVILEGES的结构。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; db ffff998e&#96;13d78060+0x40 L0x16</span><br><span class="line">ffff998e&#96;13d780a0 00 00 88 02 06 00 00 00-00 00 80 00 00 00 00 00 ................</span><br><span class="line">ffff998e&#96;13d780b0 00 00 80 40 00 00                 ...@..</span><br><span class="line"></span><br><span class="line">kd&gt; dt _SEP_TOKEN_PRIVILEGES ffff998e&#96;13d78060+0x40</span><br><span class="line">nt!_SEP_TOKEN_PRIVILEGES</span><br><span class="line">  +0x000 Present     : 0x00000006&#96;02880000</span><br><span class="line">  +0x008 Enabled     : 0x800000</span><br><span class="line">  +0x010 EnabledByDefault : 0x40800000</span><br><span class="line"></span><br><span class="line">kd&gt; p</span><br><span class="line">srv2!Srv2DecompressData+0x10d:</span><br><span class="line">fffff802&#96;18327f6d 8b442460    mov   eax,dword ptr [rsp+60h]</span><br></pre></td></tr></table></figure>

<p>单步步过之后，再查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; db ffff998e&#96;13d78060+0x40 L0x16</span><br><span class="line">ffff998e&#96;13d780a0 bc ff ff f2 1f 00 00 00-bc ff ff f2 1f 00 00 00 ................</span><br><span class="line">ffff998e&#96;13d780b0 00 00 80 40 00 00                ...@..</span><br><span class="line"></span><br><span class="line">kd&gt; dt _SEP_TOKEN_PRIVILEGES ffff998e&#96;13d78060+0x40</span><br><span class="line">nt!_SEP_TOKEN_PRIVILEGES</span><br><span class="line">  +0x000 Present     : 0x0000001f&#96;f2ffffbc</span><br><span class="line">  +0x008 Enabled     : 0x0000001f&#96;f2ffffbc</span><br><span class="line">  +0x010 EnabledByDefault : 0x40800000</span><br></pre></td></tr></table></figure>

<p>我们观察到cve-2020-0796-local.exe进程的TOKEN中的Privileges 确实被修改过了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _SEP_TOKEN_PRIVILEGES ffff8d8de&#96;1206040+0x40</span><br><span class="line">nt!_SEP_TOKEN_PRIVILEGES</span><br><span class="line">  [+0x000] Present     : 0x1ff2ffffbc [Type: unsigned __int64]</span><br><span class="line">  [+0x008] Enabled     : 0x1e60b1e890 [Type: unsigned __int64]</span><br><span class="line">  [+0x010] EnabledByDefault : 0x1e60b1e890 [Type: unsigned __int64]</span><br></pre></td></tr></table></figure>

<p>这神奇的16字节数据正是之前我们曾观察到的System进程的TOKEN中的Privileges的Present值。Present字段表示启用的特权，Enabled字段表示拥有的特权。这神奇的16字节数据覆盖写进程的Privileges结构之后，系统即拥有并启用了的system进程所有的特权。</p>
<p>我们了解到_SEP_TOKEN_PRIVILEGES是由3个bitmap构成的结构体，通过每bit是否为1来判断进程特权的。看上去应该不会超过64种特权。</p>
<h2 id="7-“有种贪心叫我全要”"><a href="#7-“有种贪心叫我全要”" class="headerlink" title="7 “有种贪心叫我全要”"></a>7 “有种贪心叫我全要”</h2><p>如果我们把这16字节全部用0xFF填充呢？</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-6.jpg" alt="img"></p>
<center>图6</center>

<p>我们使用前文所述的WinDBG手动设置了一下，如图6所示，使用whoami /PRIV命令时会提示“错误： 指定的特权不存在”。我们在微软文档中也仅发现了44中特权。</p>
<p>我们修改了Exploit的源码，编译后执行验证，并在之前的断点停下来确认符合预期。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">srv2!memmove(Src&#x3D;0xffff8205e32a2590, Dst&#x3D;0xffff998e11a4c6b0,Size&#x3D;16)</span><br><span class="line"></span><br><span class="line">srv2!Srv2DecompressData+0x108:</span><br><span class="line">fffff802&#96;18327f68 e85376ffff   call  srv2!memcpy (fffff802&#96;1831f5c0)</span><br><span class="line"></span><br><span class="line">kd&gt; r</span><br><span class="line">rax&#x3D;ffff8205e32a2290 rbx&#x3D;ffff8205e5679150 rcx&#x3D;ffff998e11a4c6b0</span><br><span class="line">rdx&#x3D;ffff8205e32a2590 rsi&#x3D;0000000000000010 rdi&#x3D;ffff8205e32a2010</span><br><span class="line">rip&#x3D;fffff80218327f68 rsp&#x3D;ffffe8861a6f9e70 rbp&#x3D;0000000000000002</span><br><span class="line"> r8&#x3D;0000000000000010 r9&#x3D;ffff8205e4e008e0 r10&#x3D;ffff8205df002160</span><br><span class="line">r11&#x3D;ffffe8861a6f9e50 r12&#x3D;0000000000000000 r13&#x3D;ffff8205e8434680</span><br><span class="line">r14&#x3D;00000000ffffffff r15&#x3D;0000000000000000</span><br><span class="line">iopl&#x3D;0     nv up ei ng nz na po nc</span><br><span class="line">cs&#x3D;0010 ss&#x3D;0018 ds&#x3D;002b es&#x3D;002b fs&#x3D;0053 gs&#x3D;002b       efl&#x3D;00000286</span><br><span class="line">srv2!Srv2DecompressData+0x108:</span><br><span class="line">fffff802&#96;18327f68 e85376ffff   call  srv2!memcpy (fffff802&#96;1831f5c0)</span><br><span class="line"></span><br><span class="line">kd&gt; db rdx L0n16</span><br><span class="line">ffff8205&#96;e32a2590 ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff ................</span><br><span class="line"></span><br><span class="line">kd&gt; db rcx L0n16</span><br><span class="line">ffff998e&#96;11a4c6b0 00 00 88 02 06 00 00 00-00 00 80 00 00 00 00 00 ................</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-7.jpg" alt="img"></p>
<center>图7</center>

<p>在图7中，结果显示这并不影响Exploit的效果，</p>
<h2 id="8-特权影响名字？"><a href="#8-特权影响名字？" class="headerlink" title="8 特权影响名字？"></a>8 特权影响名字？</h2><p>替换TOKEN不仅可以获取特权，也直接变更了账户。这个可以理解。那么问题来了，虽然修改Privileges结构，可以获得特权，但又是如何影响账户名的呢？</p>
<p>现在我们需要来看看exploit的源码。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-8.jpg" alt="img"></p>
<center>图8</center>

<p>如图8中源码显示，在修改本进程的_SEP_TOKEN_PRIVILEGES结构之后，就已经获得system进程的特权，后续调用了inject()函数。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-9.jpg" alt="img"></p>
<center>图9</center>

<p>在图9中，inject()函数中通过CreateToolhelp32Snapshot()创建进程快照，使用比较进程名的方法找到”winlogon.exe”进程。然后使用VirtualAllocEx申请了一块带有可执行属性的内存（PAGE_EXECUTE_READWRITE），WriteProcessMemory把shellcode写入目标进程，CreateRemoteThread()最终完成任务。这是一个经典的远程线程注入。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-10.jpg" alt="img"></p>
<center>图10</center>

<p>图10中shellcode应该开启cmd的功能。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-11.jpg" alt="img"></p>
<center>图11</center>

<p>如图11所示，从进程树上我们能清楚的看出cmd.exe是winlogon.exe的子进程，和powershell.exe并未任何关系。</p>
<p>winlogon.exe是以nt authority\system用户的名义启动的，而子进程继承了父进程winlogon.exe的TOKEN，也就获得了system的特权，在使用whoami命令时显示用户也就是nt authority\system。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-12.jpg" alt="img"></p>
<center>图12</center>

<p>如图12所示，选取winlogon.exe作为注入进程只是一个特例，任何以NT AUTHORITY\SYSTEM或者其他特权账户名义启动的进程都有相同的效果。</p>
<h2 id="9-应用层获取TOKEN的地址编程技巧"><a href="#9-应用层获取TOKEN的地址编程技巧" class="headerlink" title="9 应用层获取TOKEN的地址编程技巧"></a>9 应用层获取TOKEN的地址编程技巧</h2><p>前文我们介绍了如何借助WinDBG手动修改位于内核态内存的进程的访问令牌，现在我们需要了解一下exploit如何使用编程技巧从应用层获取了TOKEN的地址的。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-13.jpg" alt="img"></p>
<p>从源码上来看，其使用get_process_token()获取到了token在内核中的地址，然后利用CVE-2020-0796漏洞向ktoken+0x40处，即访问令牌中的_SEP_TOKEN_PRIVILEGES字段，写入了数据。</p>
<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-14.jpg" alt="img"></p>
<center>图 14</center>

<p><img src="/2020/04/21/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/%E5%9B%BE-15.jpg" alt="img"></p>
<center>图 15</center>

<p>在Windows上有一些众所周知的信息泄漏技巧，如本例中使用的NtQuerySystemInformation函数。这个函数有一些神奇的功能，它会返回许多内核地址。我们主要感兴趣的是此函数能够提供目前分配的每个对象的列表，使用SystemExtendedHandleInformation参数调用NtQuerySystemInformation，我们可以得到SYSTEM_HANDLE_INFORMATION_EX结构。借助此列表，我们可以使用PID和句柄获取所需对象的内核地址。</p>
<p>至此漏洞利用视角下的工作基本完成。</p>
<h2 id="10-综述"><a href="#10-综述" class="headerlink" title="10 综述"></a>10 综述</h2><p>本文介绍了2种通过手动修改进程访问令牌或特权结构提升进程权限的技巧，分析了本地权限提升exploit中使用的获取内核地址信息的技巧。带领大家近距离体会了本地权限提升利用过程。后续有机会我们再谈谈关于此漏洞的检测防护。再次提醒请尽快安装官方补丁。</p>
<h2 id="11-参考和引用"><a href="#11-参考和引用" class="headerlink" title="11 参考和引用"></a>11 参考和引用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;danigargu&#x2F;CVE-2020-0796</span><br><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;zh-cn&#x2F;windows&#x2F;win32&#x2F;secauthz&#x2F;access-tokens</span><br><span class="line">https:&#x2F;&#x2F;attack.mitre.org&#x2F;techniques&#x2F;T1134&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;zh-cn&#x2F;windows&#x2F;win32&#x2F;secauthz&#x2F;how-dacls-control-access-to-an-object</span><br><span class="line">https:&#x2F;&#x2F;bbs.pediy.com&#x2F;thread-224058-1.htm</span><br><span class="line">https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;86188</span><br></pre></td></tr></table></figure>
<h2 id="12-思考和讨论"><a href="#12-思考和讨论" class="headerlink" title="12 思考和讨论"></a>12 思考和讨论</h2><p>我们思考讨论以下3个问题有没有较好的解决办法？</p>
<ol>
<li>微软为何提供NtQuerySystemInformation函数查看SystemExtendedHandleInformation？</li>
<li>对于简单bitmap结构的_SEP_TOKEN_PRIVILEGES，能不能参考栈cookie那样的形式进行设计？</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/01/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E8%A7%86%E8%A7%92%E4%B8%8B%E7%9A%84CVE-2020-0796%E6%BC%8F%E6%B4%9E/" rel="prev" title="漏洞分析视角下的CVE-2020-0796漏洞">
      <i class="fa fa-chevron-left"></i> 漏洞分析视角下的CVE-2020-0796漏洞
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/28/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E7%BC%BA%E9%99%B7%E7%BC%93%E8%A7%A3%E6%9C%BA%E5%88%B6/" rel="next" title="Linux系统安全缺陷缓解机制">
      Linux系统安全缺陷缓解机制 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞利用视角下的CVE-2020-0796漏洞"><span class="nav-text">漏洞利用视角下的CVE-2020-0796漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-概述"><span class="nav-text">1 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-一串神奇的数字"><span class="nav-text">2 一串神奇的数字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-进程的访问令牌"><span class="nav-text">3 进程的访问令牌</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-ATT-amp-CK中的访问令牌操纵攻击技术"><span class="nav-text">4 ATT&amp;CK中的访问令牌操纵攻击技术</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-手动修改访问令牌"><span class="nav-text">5 手动修改访问令牌</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-TOKEN-0x40偏移"><span class="nav-text">6 TOKEN+0x40偏移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-“有种贪心叫我全要”"><span class="nav-text">7 “有种贪心叫我全要”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-特权影响名字？"><span class="nav-text">8 特权影响名字？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-应用层获取TOKEN的地址编程技巧"><span class="nav-text">9 应用层获取TOKEN的地址编程技巧</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-综述"><span class="nav-text">10 综述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-参考和引用"><span class="nav-text">11 参考和引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-思考和讨论"><span class="nav-text">12 思考和讨论</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">stxletto</p>
  <div class="site-description" itemprop="description">安全风云波澜壮阔，对酒当歌人间值得。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/stxletto" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;stxletto" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6355991245" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6355991245" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">stxletto</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
